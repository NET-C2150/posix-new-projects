trigger:
  branches:
    include:
      - main
      - release/*

variables:
  BuildDirName: build
  LinuxPool: ubuntu-18.04
  MacPool: macos-10.15
  BuildScriptCommonOptions: --no-color --verbose --managed-verbosity diag --configuration Release
  ArchiveNameBase: mono-posix
  HostArchiveNameBase: $(ArchiveNameBase)-host
  # Linux
  LinuxHostBuildDir: $(BuildDirName)/host-linux-release/lib
  LinuxHostArchiveName: $(HostArchiveNameBase)-linux-x64
  # Android
  AndroidArchiveNameBase: $(ArchiveNameBase)-android
  AndroidArm32BuildDir: $(BuildDirName)/android-arm32-release/lib
  AndroidArm32ArchiveName: $(AndroidArchiveNameBase)-arm32
  AndroidArm64BuildDir: $(BuildDirName)/android-arm64-release/lib
  AndroidArm64ArchiveName: $(AndroidArchiveNameBase)-arm64
  AndroidX64BuildDir: $(BuildDirName)/android-x64-release/lib
  AndroidX64ArchiveName: $(AndroidArchiveNameBase)-x64
  AndroidX86BuildDir: $(BuildDirName)/android-x86-release/lib
  AndroidX86ArchiveName: $(AndroidArchiveNameBase)-x86
  # macOS
  MacHostArchiveNameBase: $(HostArchiveNameBase)-darwin
  MacHostX64ArchiveName: $(MacHostArchiveNameBase)-x64
  MacHostArm64ArchiveName: $(MacHostArchiveNameBase)-arm64
  MacHostBuildDirBase: $(BuildDirName)/host-darwin
  MacHostX64BuildDir: $(MacHostBuildDirBase)-x64-release/lib
  MacHostArm64BuildDir: $(MacHostBuildDirBase)-arm64-release/lib
  # macCatalyst
  MacCatalystArchiveNameBase: $(ArchiveNameBase)-catalyst
  MacCatalystX64ArchiveName: $(MacCatalystArchiveNameBase)-x64
  MacCatalystArm64ArchiveName: $(MacCatalystArchiveNameBase)-arm64
  MacCatalystBuildDirBase: $(BuildDirName)/catalyst
  MacCatalystX64BuildDir: $(MacCatalystBuildDirBase)-x64-release/lib
  MacCatalystArm64BuildDir: $(MacCatalystBuildDirBase)-arm64-release/lib
  # iOS
  MacIOSArchiveNameBase: $(ArchiveNameBase)-ios
  MacIOSArm64ArchiveName: $(MacIOSArchiveNameBase)-arm64
  MacIOSArmV7ArchiveName: $(MacIOSArchiveNameBase)-armv7
  MacIOSArmV7sArchiveName: $(MacIOSArchiveNameBase)-armv7s
  MacIOSSimArm64ArchiveName: $(MacIOSArchiveNameBase)-simarm64
  MacIOSSimX64ArchiveName: $(MacIOSArchiveNameBase)-simx64
  MacIOSBuildDirBase: $(BuildDirName)/ios
  MacIOSArm64BuildDir: $(MacIOSBuildDirBase)-arm64-release/lib
  MacIOSArmV7BuildDir: $(MacIOSBuildDirBase)-armv7-release/lib
  MacIOSArmV7sBuildDir: $(MacIOSBuildDirBase)-armv7s-release/lib
  MacIOSSimArm64BuildDir: $(MacIOSBuildDirBase)-simarm64-release/lib
  MacIOSSimX64BuildDir: $(MacIOSBuildDirBase)-simx64-release/lib
  # tvOS
  MacTVOSArchiveNameBase: $(ArchiveNameBase)-tvos
  MacTVOSArm64ArchiveName: $(MacTVOSArchiveNameBase)-arm64
  MacTVOSSimX64ArchiveName: $(MacTVOSArchiveNameBase)-simx64
  MacTVOSBuildDirBase: $(BuildDirName)/tvos
  MacTVOSArm64BuildDir: $(MacTVOSBuildDirBase)-arm64-release/lib
  MacTVOSSimX64BuildDir: $(MacTVOSBuildDirBase)-simx64-release/lib
  # managed
  ManagedArchiveName: $(ArchiveNameBase)-managed
  ManagedBuildDir: $(BuildDirName)/managed/Release

stages:
- stage: Build
  jobs:
  - job: linux_build_host
    displayName: Build for Linux
    pool:
      vmImage: '$(LinuxPool)'
    workspace:
      clean: all
    steps:
    - template: templates/linux-common.yaml

    - bash: |
        ./build.sh $(BuildScriptCommonOptions) host

    - template: templates/pack-artifact.yaml
      parameters:
        buildDir: '$(LinuxHostBuildDir)'
        archiveName: '$(LinuxHostArchiveName)'
        displayName: 'Archive Linux host build'

    - task: PublishBuildArtifacts@1
      displayName: Upload Artifacts
      inputs:
        artifactName: 'Host'
        pathToPublish: $(Build.ArtifactStagingDirectory)

  - job: linux_build_android
    displayName: Build for Android
    pool:
      vmImage: '$(LinuxPool)'
    workspace:
      clean: all
    steps:
    - template: templates/linux-common.yaml

    - bash: |
        ./build.sh $(BuildScriptCommonOptions) --ndk $(ANDROID_NDK_HOME) android

    - template: templates/pack-artifact.yaml
      parameters:
        buildDir: '$(AndroidArm32BuildDir)'
        archiveName: '$(AndroidArm32ArchiveName)'
        displayName: 'Archive Android ARM32 build'

    - template: templates/pack-artifact.yaml
      parameters:
        buildDir: '$(AndroidArm64BuildDir)'
        archiveName: '$(AndroidArm64ArchiveName)'
        displayName: 'Archive Android ARM64 build'

    - template: templates/pack-artifact.yaml
      parameters:
        buildDir: '$(AndroidX86BuildDir)'
        archiveName: '$(AndroidX86ArchiveName)'
        displayName: 'Archive Android x86 build'

    - template: templates/pack-artifact.yaml
      parameters:
        buildDir: '$(AndroidX64BuildDir)'
        archiveName: '$(AndroidX64ArchiveName)'
        displayName: 'Archive Android x86_64 build'

    - task: PublishBuildArtifacts@1
      displayName: Upload Artifacts
      inputs:
        artifactName: 'Android'
        pathToPublish: $(Build.ArtifactStagingDirectory)

  - job: mac_build_host
    displayName: Build for macOS
    pool:
      vmImage: '$(MacPool)'
    workspace:
      clean: all
    steps:
    - template: templates/mac-common.yaml

    - template: templates/mac-build.yaml
      parameters:
        buildTarget: 'host'
        x64BuildDir: $(MacHostX64BuildDir)
        x64ArchiveName: $(MacHostX64ArchiveName)
        arm64BuildDir: $(MacHostArm64BuildDir)
        arm64ArchiveName: $(MacHostArm64ArchiveName)
        publishArtifactName: 'Host'

  - job: mac_build_catalyst
    displayName: Build for macOS Catalyst
    pool:
      vmImage: '$(MacPool)'
    workspace:
      clean: all
    steps:
    - template: templates/mac-common.yaml

    - template: templates/mac-build.yaml
      parameters:
        buildTarget: 'catalyst'
        x64BuildDir: $(MacCatalystX64BuildDir)
        x64ArchiveName: $(MacCatalystX64ArchiveName)
        arm64BuildDir: $(MacCatalystArm64BuildDir)
        arm64ArchiveName: $(MacCatalystArm64ArchiveName)
        publishArtifactName: 'macOS Catalyst'

  - job: mac_build_ios
    displayName: Build for iOS
    pool:
      vmImage: '$(MacPool)'
    workspace:
      clean: all
    steps:
    - template: templates/mac-common.yaml

    - template: templates/ios-build.yaml
      parameters:
        buildDirArm64: '$(MacIOSArm64BuildDir)'
        buildDirArmV7: '$(MacIOSArmV7BuildDir)'
        buildDirArmV7s: '$(MacIOSArmV7sBuildDir)'
        buildDirSimArm64: '$(MacIOSSimArm64BuildDir)'
        buildDirSimX64: '$(MacIOSSimX64BuildDir)'
        archiveNameArm64: '$(MacIOSArm64ArchiveName)'
        archiveNameArmV7: '$(MacIOSArmV7ArchiveName)'
        archiveNameArmV7s: '$(MacIOSArmV7sArchiveName)'
        archiveNameSimArm64: '$(MacIOSSimArm64ArchiveName)'
        archiveNameSimX64: '$(MacIOSSimX64ArchiveName)'
        publishArtifactName: 'iOS'

  - job: mac_build_tvos
    displayName: Build for tvOS
    pool:
      vmImage: '$(MacPool)'
    workspace:
      clean: all
    steps:
    - template: templates/mac-common.yaml

    - template: templates/tvos-build.yaml
      parameters:
        buildDirArm64: '$(MacTVOSArm64BuildDir)'
        buildDirSimX64: '$(MacTVOSSimX64BuildDir)'
        archiveNameArm64: '$(MacTVOSArm64ArchiveName)'
        archiveNameSimX64: '$(MacTVOSSimX64ArchiveName)'
        publishArtifactName: 'tvOS'

  - job: mac_build_managed
    displayName: Build managed
    pool:
      vmImage: '$(MacPool)'
    workspace:
      clean: all
    steps:
    - bash: |
        ./build.sh $(BuildScriptCommonOptions) managed

    - template: templates/pack-artifact.yaml
      parameters:
        buildDir: '$(ManagedBuildDir)'
        archiveName: '$(ManagedArchiveName)'
        displayName: 'Archive Managed code'

    - task: PublishBuildArtifacts@1
      displayName: Upload Artifacts
      inputs:
        artifactName: 'Managed'
        pathToPublish: $(Build.ArtifactStagingDirectory)
